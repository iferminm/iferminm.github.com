<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Israel Fermín Montilla" />
        <meta name="copyright" content="Israel Fermín Montilla" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="heroku, herramientas, tecnología, programación, Blog, " />

<meta property="og:title" content="Heroku + Django sin morir en el intento (Parte 2) "/>
<meta property="og:url" content="http://localhost:8000/heroku-django-sin-morir-en-el-intento-parte-2.html" />
<meta property="og:description" content="En el artículo anterior, hablamos de IaaS y de PaaS y de cómo se diferencian concluimos que Heroku es PaaS, además, expusimos algunas de las limitaciones que nos impone la plataforma para desplegar nuestras aplicaciones y cómo trabajar alrededor de ellas para hacer funcionar todo. Muchas veces, quizás por inocentes ..." />
<meta property="og:site_name" content="@#$%_" />
<meta property="og:article:author" content="Israel Fermín Montilla" />
<meta property="og:article:published_time" content="2014-09-20T12:34:00-04:30" />
<meta name="twitter:title" content="Heroku + Django sin morir en el intento (Parte 2) ">
<meta name="twitter:description" content="En el artículo anterior, hablamos de IaaS y de PaaS y de cómo se diferencian concluimos que Heroku es PaaS, además, expusimos algunas de las limitaciones que nos impone la plataforma para desplegar nuestras aplicaciones y cómo trabajar alrededor de ellas para hacer funcionar todo. Muchas veces, quizás por inocentes ...">

        <title>Heroku + Django sin morir en el intento (Parte 2)  · @#$%_
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://localhost:8000/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://localhost:8000/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://localhost:8000/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://localhost:8000/theme/css/custom.css" media="screen">
        <link href="http://localhost:8000/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="@#$%_ - Full Atom Feed" />
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-55459920-1', 'auto');
    ga('send', 'pageview');
</script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://localhost:8000/"><span class=site-name>@#$%_</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://localhost:8000">Home</a></li>
                            <li ><a href="http://localhost:8000/categories.html">Categories</a></li>
                            <li ><a href="http://localhost:8000/tags.html">Tags</a></li>
                            <li ><a href="http://localhost:8000/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://localhost:8000/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="http://localhost:8000/heroku-django-sin-morir-en-el-intento-parte-2.html"> Heroku + Django sin morir en el intento (Parte 2)  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <p>En el artículo anterior, hablamos de IaaS y de PaaS y de cómo se diferencian
concluimos que <em>Heroku</em> es PaaS, además, expusimos algunas de las limitaciones
que nos impone la plataforma para desplegar nuestras aplicaciones y cómo trabajar
alrededor de ellas para hacer funcionar todo.</p>
<p>Muchas veces, quizás por inocentes o inexpertos, tendemos a hacer todo en la vista
(y hablo de vistas de <em>django</em>), por ejemplo, necesitamos enviar algo al servidor
donde hosteamos las imágenes, simplemente hacemos ejecutamos ese request en la vista,
necesitamos enviar un correo electrónico de confirmación, nada, lo enviamos en la vista,
necesitamos procesar una imagen para reducir la calidad y que ocupe menos espacio en
el servidor donde la vamos a hostear, dale... en la vista.</p>
<p>Bueno, exagero un poco, quizás no en la vista, si somos estrictos con nuestro código,
escribiremos una función que suba la foto al servidor, otra que envíe el correo y otra
que procese la imagen para reducir el tamaño y llamaremos todo desde la vista. Este
enfoque sigue estando errado y, a continuación, voy a explicar por qué.</p>
<p>Todos venimos de hacer proyectos en la universidad, algunos más difíciles que otros,
en algún proyecto, seguramente nos tocó realizar llamadas a alguna <em>API REST</em>, o
enviar algún archivo a un servidor remoto, en todos los casos, estoy seguro de que
todos hicimos lo mismo, una función que se ejecuta cuando enviamos el formulario y
hace todo en línea: llamadas remotas, envío de archivos, envío de correos, etc.</p>
<p>No es incorrecto, funciona, pero ¿cuánto tardó la página siguiente en cargar?, la
pregunta más adecuada sería ¿cuánto tiempo tardó la función en redirigirme a la
siguiente página?, calculemos unos 3 a 5 segundos por llamada remota y unos 2 a 3
segundos, total, alrededor de 15 segundos en redirigir, a eso hay que sumarle
el tiempo de carga de la página siguiente.</p>
<p>Particularmente, mi primer trabajo fue en el mundo de los ERP, es una historia
totalmente distinta, si una persona manda a generar un reporte que tarda 4 horas
en ejecutarse y para ello el programa se bloquea y no le permite hacer más nada,
simplemente no tiene otra opción más que esperar las 4 horas sentado en su escritorio,
ir a tomarse un café, bajar a fumar un cigarrillo hasta que esté listo.</p>
<p>Cuando programas para web, debes tomar en cuenta que debes ser gentil con el usuario
y no hacerlo esperar, tu página debe responder rápido, sino, hay muchas otras páginas
que hacen lo mismo y el usuario simplemente tiene que regresar a la pestaña del navegador
donde está su búsqueda en google y seleccionar otro resultado. Una buena <em>rule of thumb</em>
a la hora de ejecutar operaciones pesadas, como todas las que incluyan llamadas remotas
o procesamiento de imágenes, es realizarlas de manera asíncrona, para ello debemos
valernos de <em>algo</em> que nos permita retrasar la ejecución de una tarea.</p>
<p>Por un lado, necesitaremos algo que nos sirga para mantener una cola de tareas pendientes
por ejecutar, por otro lado necesitamos algo que vaya leyendo esas tareas y ejecutándolas,
la manera más simple de hacerlo en <em>Python</em> es con una librería llamada <em>python-rq</em> y
usando <em>Redis</em> como backend de tareas, es muy fácil de configurar y súper sencilla de usar
para la mayoría de proyectos pequeños a medianos funcionará bastante bien. Para proyectos
a mayor escala, quizás lo mejor sea utilizar <em>celery</em> con <em>RabbitMQ</em> como broker de mensajes.
Hay muchas herramientas que podemos usar como backend de mensajes: Redis, RabbitMQ, ZeroMQ,
Kafka, HornetQ... es cuestión de evaluarlas y ver cuál se ajusta más al proyecto en cuestión
en el cual estamos trabajando.</p>
<p>Como todo en <em>django</em>, tenemos un paquete llamado <em>django-rq</em> que nos ayuda a organizar
el código de una mejor manera y nos hace la vida más fácil, empecemos por descargar
las librerías y paquetes necesarias:</p>
<div class="highlight"><pre>sudo aptitude install redis-server
pip install django-rq django
</pre></div>
<p>Si estamos en <em>Heroku</em>, no es necesario instalar <em>redis</em>, simplemente agregar los nuevos
paquetes Python al <em>requirements.txt</em> para que sean instalados al hacer <em>push</em></p>
<p>Para poder agregar trabajos a las colas, debemos declararlas para que <em>django-rq</em> las
reconozca, simplemente agregamos una nueva variable en nuestro <em>settings.py</em>. A continuación
un ejemplo de configuración para <em>django_rq</em>, la cola <em>default</em> es un ejemplo para desarrollo,
la cola <em>high</em> es un ejemplo de configuración para Heroku si estamos usando el <em>add on</em> de
<em>Redis To Go</em>.</p>
<div class="highlight"><pre><span class="n">RQ_QUEUES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;HOST&#39;</span><span class="p">:</span> <span class="s">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="s">&#39;PORT&#39;</span><span class="p">:</span> <span class="mi">6379</span><span class="p">,</span>
        <span class="s">&#39;DB&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s">&#39;high&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;HOST&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;REDISTOGO_URL&#39;</span><span class="p">),</span>
        <span class="s">&#39;PORT&#39;</span><span class="p">:</span> <span class="mi">6379</span><span class="p">,</span>
        <span class="s">&#39;DB&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Ahora, las funciones sumamente pesadas pueden ser encoladas en cualquiera de las dos
colas que hemos declarado en <em>settings.py</em>.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">funcion_sumamente_pesada</span><span class="p">(</span><span class="n">argumento</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
<p>Lo que haremos en nuestra vista es, en vez de llamar a la función directamente, le diremos
a <em>django_rq</em> que agregue el trabajo en la cola que consideremos conveniente.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">django_rq</span>
<span class="kn">from</span> <span class="nn">helpers</span> <span class="kn">import</span> <span class="n">funcion_sumamente_pesada</span>

<span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c">#...</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">django_rq</span><span class="o">.</span><span class="n">get_queue</span><span class="p">(</span><span class="s">&#39;high&#39;</span><span class="p">)</span> <span class="c"># si no indicamos una cola, retorna la cola &#39;default&#39;</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">funcion_sumamente_pesada</span><span class="p">,</span> <span class="n">argumento</span><span class="p">)</span>
</pre></div>
<p>También decorar las funciones que queremos encolar, esto hace que el código se vea un poco más
limpio, pero el efecto es el mismo:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django_rq</span> <span class="kn">import</span> <span class="n">job</span>

<span class="nd">@job</span><span class="p">(</span><span class="s">&#39;high&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">funcion_sumamente_pesada</span><span class="p">(</span><span class="n">argumentos</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
<p>Y luego, en la vista:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c">#...</span>
    <span class="n">funcion_sumamente_pesada</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">argumento</span><span class="p">)</span>
</pre></div>
<p>Lo que rq hace es tomar el <em>objeto función</em>, serializarlo usando <em>pickle</em> y guardar ese objeto
serializado en redis. Ahora que tenemos el trabajo encolado, necesitamos <em>algo</em> para leerlo de
redis, des-serializarlo y ejecutarlo.</p>
<p>RQ, viene con un worker que podemos ejecutar en un <em>dyno</em> aparte (recuerden agregar la entrada
correspondiente en el <em>Procfile</em> de Heroku), simplemente corremos el siguiente comando
en el terminal para probar localmente:</p>
<div class="highlight"><pre>python manage.py rqworker high default
</pre></div>
<p>En la consola, podemos ver cómo los trabajos se van ejecutando, incluso, si apagamos el worker y
mandamos a encolar algunos trabajos, al ejecutar de nuevo el worker de rq podemos ver como los
va leyendo de redis y los ejecuta.</p>
<div class="section" id="consideraciones-con-objetos-persistentes-en-base-de-datos">
<h2>Consideraciones con objetos persistentes en base de datos</h2>
<p>Bueno, ya sabemos que rq hace un <em>pickle</em> de la función y sus argumentos y envía esa información
a <em>Redis</em> para luego ser leído por el worker, hacer el <em>unpickle</em> y ejecutar el trabajo.</p>
<p>A menudo, necesitamos hacer <em>delay</em> de un trabajo que actúa sobre objetos que persisten en la base
de datos, nuestra primera tentación es simplemente pasar los objetos como argumentos al trabajo.</p>
<p>Ahora, veamos, analicemos qué ocurrirá. Al encolar el trabajo tanto la función como sus argumentos
serán serializados, estos argumentos son objetos que pueden ser modificados. Luego de encolar, supongamos
que modifico uno de los atributos del objeto y lo guardo en la base de datos, luego, al ejecutarse mi trabajo
la función también modifica otro atributo y guarda el objeto en la base de datos.</p>
<p>Lo que va a ocurrir es que, como la referencia que fue serializada al momento de encolar está desactualizada,
la modificación que se hizo luego de encolar no estará reflejada en el objeto luego de ejecutar el trabajo.</p>
<div class="section" id="la-solucion">
<h3>La solución</h3>
<p>Simplemente no pasar objetos persistentes como argumentos, es mucho mejor simplemente dar los
<em>id</em> de base de dato al trabajo y que dentro de la función se ejecute un query para traerlos,
de esta manera evitamos conflictos y dolores de cabeza como el antes descrito.</p>
<p>Espero que esto sea de ayuda, es buena práctica trabajar con colas para trabajos pesados
en cualquier proyecto web, no sólo si estamos corriendo nuestra app en Heroku.</p>
</div>
</div>

            <section>
    <p id="post-share-links">
    Compártelo
    <a href="http://twitter.com/home?status=Heroku%20%2B%20Django%20sin%20morir%20en%20el%20intento%20%28Parte%202%29%20http%3A//localhost%3A8000/heroku-django-sin-morir-en-el-intento-parte-2.html" target="_blank" title="Share on Twitter">Twitter</a>
    ❄
    <a href="http://www.facebook.com/sharer/sharer.php?s=100&amp;p%5Burl%5D=http%3A//localhost%3A8000/heroku-django-sin-morir-en-el-intento-parte-2.html" target="_blank" title="Share on Facebook">Facebook</a>
    ❄
    <a href="https://plus.google.com/share?url=http%3A//localhost%3A8000/heroku-django-sin-morir-en-el-intento-parte-2.html" target="_blank" title="Share on Google Plus">Google+</a>
    ❄
    <a href="mailto:?subject=Heroku%20%2B%20Django%20sin%20morir%20en%20el%20intento%20%28Parte%202%29&amp;body=http%3A//localhost%3A8000/heroku-django-sin-morir-en-el-intento-parte-2.html" target="_blank" title="Share via Email">Email</a>
    </p>
</section>

            <section>
<p id="comment-message">Preguntas, comentatios, chistes o sugerencias, por acá. </p>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                href="http://localhost:8000/heroku-django-sin-morir-en-el-intento-parte-2.html#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'iferminmblog';
        var disqus_identifier = 'http://localhost:8000/heroku-django-sin-morir-en-el-intento-parte-2.html';
    var disqus_url = 'http://localhost:8000/heroku-django-sin-morir-en-el-intento-parte-2.html';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
            </div>
        </div>
    </div>
</div>
</section>

            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2014-09-20T12:34:00-04:30">Sep 20, 2014</time>
            <h4>Category</h4>
            <a class="category-link" href="http://localhost:8000/categories.html#blog-ref">Blog</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="http://localhost:8000/tags.html#heroku-ref">heroku
                    <span>2</span>
</a></li>
                <li><a href="http://localhost:8000/tags.html#herramientas-ref">herramientas
                    <span>3</span>
</a></li>
                <li><a href="http://localhost:8000/tags.html#programacion-ref">programación
                    <span>9</span>
</a></li>
                <li><a href="http://localhost:8000/tags.html#tecnologia-ref">tecnología
                    <span>3</span>
</a></li>
            </ul>
<h4>Sígueme!</h4>
    <a href="http://twitter.com/iferminm" title="My Twitter Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-twitter sidebar-social-links"></i></a>
    <a href="http://www.linkedin.com/profile/view?id=66587805&amp;trk=tab_pro" title="My LinkedIn Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-linkedin sidebar-social-links"></i></a>
    <a href="https://github.com/iferminm" title="My GitHub Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="mailto:iferminmontilla@gmail.com" title="My Email Address" class="sidebar-social-links" target="_blank">
    <i class="fa fa-envelope sidebar-social-links"></i></a>
<!-- Begin MailChimp Signup Form -->
<div id="mc-embed-signup">
<form action="http://iferminmontilla.us11.list-manage.com/subscribe/post?u=0d4b15ef6a90baa460d821dbc&id=8b51ac80b2" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
<h4>Suscríbete</h4>
<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="Pasa tu correo pues..." required>
<div class="clear"><input type="submit" value="Ok, pero sin spam" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
</form>
</div>
<!--End mc_embed_signup-->
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

            <script type="text/javascript">
var disqus_shortname = 'iferminmblog';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script  language="javascript" type="text/javascript">
function uncollapse() {
    if (window.location.hash.match(/^#comment-\d+$/)) {
        $('#disqus_thread').collapse('show');
    }
}
</script>
<script type="text/javascript" language="JavaScript">
uncollapse();
window.onhashchange=function(){
    if (window.location.hash.match(/^#comment-\d+$/))
        window.location.reload(true);
}
</script>
<script>
$('#disqus_thread').on('shown', function () {
    var link = document.getElementsByClassName('accordion-toggle');
    var old_innerHTML = link[0].innerHTML;
    $(link[0]).fadeOut(500, function() {
        $(this).text('Click here to hide comments').fadeIn(500);
    });
    $('#disqus_thread').on('hidden', function () {
        $(link[0]).fadeOut(500, function() {
            $(this).text(old_innerHTML).fadeIn(500);
        });
    })
})
</script>


    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>