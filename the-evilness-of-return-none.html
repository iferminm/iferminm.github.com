<!DOCTYPE html>
<html lang="en">
<head>
        <title>The evilness of return None!</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="http://localhost:8000/theme/css/main.css" />
        <link href="http://localhost:8000/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="/dev/isra/blog/* Full Atom Feed" />
        <link href="http://localhost:8000/feeds/blog.atom.xml" type="application/atom+xml" rel="alternate" title="/dev/isra/blog/* Categories Atom Feed" />
</head>
<body>

    <div class="main-nav-container">

        <div class="pure-g">
            <div class="pure-u-1 pure-u-lg-2-3">
                <div class="main-nav">
                    <ul class="main-nav-list">
                        <li class="main-nav-item"><a href="http://localhost:8000/" class="pure-menu-link">/dev/isra/blog/*</a></li>

                        <li class="main-nav-item active"><a href="http://localhost:8000/category/blog.html" class="pure-menu-link">Blog</a></li>
                        <li class="main-nav-item"><a href="http://localhost:8000/category/espanol.html" class="pure-menu-link">Español</a></li>
                    </ul>
                </div>
             </div>

             <div class="pure-u-1 pure-u-lg-1-3"></div>
        </div>

    </div>


<div class="page-container">
    <div class="entry-content">
        <div class="post-meta pure-g">
            <div class="pure-u-3-4 meta-data">
                <a href="http://localhost:8000/category/blog.html" class="category">Blog</a><br />

                <a class="author" href="http://localhost:8000/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
                &mdash; <abbr title="2017-03-13T00:00:00+04:00">Mon 13 March 2017</abbr>
            </div>
        </div>
    </div>

    <div class="article-header-container">
        <div class="background-image-container">

            <div class="background-image-small">
                <div class="title-container">
                    <h1>The evilness of return None!</h1>
                </div>
            </div>
        </div>
    </div>

    <div class="entry-content">
        <p>Recently at work, i was solving one bug on one of our services, 
it was popping up in newrelic at least 9 times a week, 
this is one of the services we use in the monetization process 
at the office, so, it's a critical one, the least errors we 
see in newrelic for this service, the better.</p>
<p>The error looked a bit like a nonsense, basically some user's 
subscriptions were coming as <code>null</code> values or <code>None</code>, in Python.</p>
<p>Debugging the code and tracing the logs I found the like where 
it was failing and it looked something like this:</p>
<div class="highlight"><pre><span></span><span class="n">subscription</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_oldest_subscription_for_addon</span><span class="p">(</span><span class="n">addon_id</span><span class="p">)</span>
<span class="n">package</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">package</span>  <span class="c1"># This was the failing line</span>
</pre></div>


<p>The method says it returns a <code>subscription</code> object, but it's 
returning <code>None</code>, why?</p>
<p>I digged deeper and opened the <code>models.py</code> file I searched for the 
method's name and bingo! I got it!</p>
<div class="highlight"><pre><span></span>    <span class="c1"># ...</span>
    <span class="k">def</span> <span class="nf">get_oldest_subscription_for_addon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addon_id</span><span class="p">)</span>
        <span class="n">subscriptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_subscriptions</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">subscription</span> <span class="ow">in</span> <span class="n">subscriptions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subscription</span><span class="o">.</span><span class="n">addon_credits_left</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">addon_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">subscription</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>


<p>And... that's where the <code>None</code> is comming from...</p>
<p>Since i read Clean Code by Uncle Robert Martin, I try to 
keep in mind the key principles of what should be clean code. 
Everything from naming to design patterns, single responsibility 
principle, the newspaper principle, keeping things as short 
and simple as posible which also goes along with the Zen of Python.</p>
<p>One of the principles I learned by reading Clean Code has to do with Naming. All names should be intuitive, it should describe in few words what the
class is, what the method does or what the attribute or variable holds, no matter how long the name is, with some limits and without exagerating or
being too verbose, which takes me to the second principle I'm going to talk about, which os borrowed from the art of unix programming check reference,
"a function must perform one and only one action without side effects". If we stick to this two rules, the name of our functions should intuitive,
because it will describe the action, and short enough because it will do only one thing.</p>
<p>This is also a good way to diagnose if I'm writing good code, whenever I'm naming a function and I'm being forced by rule number 1 to add an "and" or
and "or" to the name of the function, I'm probably breaking rule number 2.</p>
<p>With some exceptions, for example, some functions could take a different course of action under certain conditions, for example, django's
get_object_or_404() shortcut, and also manager's method get_or_create() and update_or_create() are keeping us from taking care of very common web
application and databases flows like returning 404 if we don't find an object, creating an object if it's not there yet and it has to be or performing
an upcert operation.</p>
<p>This could lead to long names sometimes but nowadays we have autocompletion tools and flexible line length rules so i don't think it's too much of a
big deal.</p>
<p>Two ways this could have been avoided are</p>
<p>1.- Docstring: nowadays we use integrated development environments (IDE) and all of them provide some meta information about the objects in our code
by hovering over the name, there are also plugins for most of the editors out there... vim, emacs, sublime... atom you name it. By writing a proper
docstring for that method, it will be picked up and shown as a tooltip by one of these tools, no matter which editor we use, if we have one of those
code completion plugins, it will show up. This isn't too intuitive, and doesn't provide the information right away, you have to read the docstring
somehow and, if you don't have a good code completion tool, you will still need to open the models.py file and read what the code does.</p>
<p>2.- Function should had been called get_oldelst_subscription_with_credits_or_none(): yes, name is too long, but at least the programmer using that
function would be aware of the return None behavior while using that function without having to open the file that denifes it.</p>
<p>3.- Raise an exception and handle it: the method should return a subscription object and it assumes it will find one, so, not being able to return one
is an anomaly, so, we could create a cuatom exception and raise it from the model so the view can handle it.</p>
<p>I opted for option 2, although is not the cleanest one, because of the way the code was written it was the one that supposed less changes to the code.</p>
<p>I just renamed the function and changed all of the invocations and moved that specific one below a check that was already there. Committed, pushed and
released the bugfix and that was it. After that, i got curious about who wrote that code, so, i went back on git's history and ran a git blame.
Surprise :) it was me :).</p>
    </div>

    <footer>
        <div class="tags">
            <a href="http://localhost:8000/tag/programming.html">programming</a>
            <a href="http://localhost:8000/tag/python.html">python</a>
        </div>
        <div class="pure-g post-footer">
            <div class="pure-u-1 pure-u-md-1-2">
                <div class="pure-g poster-info">
                    <div class="pure-u-3-4">
                        <h3 class="author-name"><a href="http://localhost:8000/author/israel-fermin-montilla.html">Israel Fermín Montilla</a></h3>
                        <p class="author-description">
                        </p>
                    </div>
                </div>
            </div>



        </div>


    </footer>

    <div class="entry-content">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'iferminmblog';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

</div>


    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-55459920-1', 'auto');
      ga('send', 'pageview');

    </script>
</body>
</html>