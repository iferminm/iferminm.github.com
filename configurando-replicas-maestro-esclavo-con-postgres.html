<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Configurando réplicas Maestro-Esclavo con Postgres - Israel Fermín Montilla</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="http://localhost:8000/theme/css/iferminm.css">
</head>
<body>
    <div id="header">
        <div id="header-logo-holder">
            <a href="http://localhost:8000"><img src="http://localhost:8000/theme/images/header-logo.png" alt=""></a>    
        </div>
        <div id="logo-text">
            <span><b>Israel Fermín Montilla</b></span>
            <span>Software Engineer</span>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-2">
            <div class="collapse navbar-collapse" id="nav-elements">
                <ul class="nav nav-pills nav-stacked">
                    <li class="active"><a href="http://localhost:8000">Blog</a></li>
                </ul>
            </div>
            <div class="under-menu-ad">
                <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                <!-- Blog under menu -->
                <ins class="adsbygoogle"
                    style="display:block"
                    data-ad-client="ca-pub-9066997121369275"
                    data-ad-slot="3361083144"
                    data-ad-format="auto">
                </ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>
        <div class="col-xs-9">
            <div id="main-content" class="ckontainer"> 
<div class="article-header">
    <h1>Configurando réplicas Maestro-Esclavo con Postgres</h1> 
    by <a href="author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
</div>

<p>Muchas veces, por alguna razón, hacemos desde la capa de
aplicación cientos de validaciones y procesos que, si sabemos cómo,
podríamos delegar en el manejador de base de datos. Las validaciones de
reglas de negocio son un ejemplo muy frecuente de ello, tendemos, por
ejemplo, a implementar validaciones redundantes (en el caso de entornos
web) del lado del cliente, utilizando AJAX, y del lado del servidor,
utilizando el lenguaje de programación que más nos agrade. Esto, añade
un nivel de complejidad a nuestro sistema, cuando, muy tranquilamente,
podríamos delegar esa validación en nuestro manejador de base de datos a
través de un Trigger, con la ventaja de que si algún día, otro sistema
necesita conectarse a la base de datos, las reglas de negocio están
implementadas directamente en el manejador y, como ya estamos
acostumbrados, todo corre más rápido en el nivel más bajo. Ahora bien,
¿por qué empiezo diciendo todo eso?, simplemente por hacer referencia a
un ejemplo bastante común, en el que nosotros, programadores,
desarrolladores, ingenieros, o como quieran llamarnos, hacemos uso (o
quizás sub-uso) de un software muy sofisticado, como lo es un Manejador
de Base de Datos y, tendemos a pensar, que es sólo un pote para guardar
datos que, además, habla un lenguaje extraño llamado SQL. Otra de las
cosas que, algunas veces, hacemos y nos hacen parecer novatos es
actualizar dos servidores de base de datos distintos disparando
sentencias hacia los dos, o tres, o cuantos sean. Esto añade un nivel de
complejidad innecesario a nuestra aplicación, además de estar
fuertemente acoplado con la arquitectura física (hardware) del sistema
implementado, si el número de servidores a sincronizar cambia, será
necesario también realizar modificaciones a nivel de código o de
configuración del programa y, además, desaprovechamos la potencia que
nos ofrece un manejador de base de datos. PostgresSQL nos ofrece la
posibilidad de sincronizar dos servidores de base de datos mediante
Replicación. Existen distintos tipos de replicación de servidores, en
este caso, configuraremos un esquema Maestro-Esclavo, en el que mi
servidor Maestro, recibe y ejecuta todas las transacciones y, además,
actualiza a mi servidor Esclavo, que, únicamente, realiza consultas.
Empezamos por instalar la última versión disponible de Postgres,
utilizando el gestor de paquetes de nuestra distribución de Linux
favorita, para este ejemplo, utilicé Debian Wheezy (Testing) y Postgres
9.1.</p>
<div class="section" id="configurando-el-maestro">
<h2>Configurando el Maestro</h2>
<p>El maestro, es el nodo que ejecuta todas las transacciones de base de
datos, digamos que puede realizar todas las operaciones CRUD. Empecemos
por establecer ciertos valores de configuración para el manejador en el
archivo /etc/postgresql/9.1/main/postgresql.conf. Debemos configurar los
siguientes valores:</p>
<p>`` listen_addresses = '*' wal_level = hot_standby wal_sync_method = fsync max_wal_senders = 2 wal_keep_segments = 8``</p>
<p>El parámetro <em>listen_addresses</em> establece las direcciones IP de donde
mi servidor va a aceptar peticiones, este parámetro acepta valores
separados por coma o el caracter asterisco, como en este caso, para
especificar que va a aceptar peticiones de cualquier host, de no ser
así, sólo las IP listadas podrían sincronizar la base de datos. El valor
de <em>wal_level</em>, donde &quot;wal&quot; quiere decir &quot;Write Ahead Log&quot; y es una
estrategia que implementan los manejadores para cumplir con las
propiedades de Atomicidad y Durabilidad de las transacciones (¿recuerdan
la regla ACID?) y consiste en escribir en un archivo de bitácora todas
las modificaciones realizadas a la base de datos. En Postgres existen
tres: <em>minimal</em>, que omite algunas operaciones de escritura para hacer
las operacionas más rápido, pero no guarda información suficiente para
reconstruir la base de datos a partir de un archivo inicial y logs de
este tipo, <em>hot_standby</em> y <em>archive</em>, almacenan toda la información
necesaria para hacer la reconstrucción completa de los datos, pero
únicamente <em>hot_standby</em> permite implementar replicación de base de
datos hacia servidores remotos. La opción <em>wal_sync_method</em> es el
método que utilizará el manejador para forzar las actualizaciones
utilizando WAL. En este caso, utilizamos <em>fsync</em> que se asegura de que
los cambios sean escritos físicamente en la base de datos copia, más
información sobre los métodos de sincronización disponibles puede
conseguirse en [1]. El parámetro <em>max_wal_senders</em> establece el número
de sincronizaciones concurrentes que puede ejecutar el servidor.
Finalmente, <em>wal_keep_segments</em>, establece el número de WAL LOGS que
el servidor guardará en el directorio pg_xlog, estos logs son
utilizados para realizar el las actualizaciones vía streaming. Una vez
hecho lo anterior, tenemos la configuración básica de Postgres para
hacer replicación Maestro-Esclavo vía streaming. Ahora, debemos agregar
una regla más de acceso al pg_hba.conf, para permitir a los esclavos
conectarse al servidor maestro:</p>
<p>`` host replication all 10.1.1.8/32 trust``</p>
<p>Con esa línea, estamos
configurando el servidor para que permita conexiones a todos los
usuarios con permiso de replicación desde la sub-red 10.1.1.8/32. Ahora,
generamos los WAL, para ello, ejecutamos lo siguiente:
`` postgres# SELECT pg_start_backup('1')`` Mientras eso esté ocurriendo,
en otro terminal, hacemos lo siguiente:
`` # cd /var/lib/postgresql/9.1 # tar czvf backup.tgz main`` Con esto,
estamos comprimiendo el directorio de datos de Postgres. Una vez hecho
esto, detenemos la generación de WAL:
`` postgres# SELECT pg_stop_backup()`` El asunto general se resume con
la siguiente ecuación: backup inconsistente + WAL = restauración a
estado consistente. Estos WAL, se generan en el directorio pg_xlog, y
debemos tomar el último que fue escrito.</p>
</div>
<div class="section" id="configurando-el-esclavo">
<h2>Configurando el Esclavo</h2>
<p>Lo primero que debemos hacer es sustituir el directorio de datos de esta
instancia de Postgres por el directorio de datos del Maestro. Luego,
creamos un directorio <em>recovery</em>, donde copiaremos el último WAL del
directorio pg_xlog. Adicionalmente, debemos modificar el
postgresql.conf con las siguientes variables:</p>
<p>`` hot_standby = on wal_level = hot_standby``</p>
<p>Ahora, creamos un archivo
de configuración en la raíz del directorio de datos establecer las
siguientes opciones:</p>
<p>`` standby_mode = 'on' primary_conninfo = 'host=[host_ip] port=5432 user=root password=[some_password]' restore_command = 'cp /var/lib/postgresql/9.1/main/recovery/%f %p'``</p>
<p>Con esto le decimos al servidor que va a esperar réplicas de
<em>primary_conninfo</em>, además, el <em>restore_command</em> indica dónde se
encuentra el respaldo inicial inconsistente. Finalmente, nos aseguramos
de que los roles tengan permiso de replicación:</p>
<p>`` postgres# SELECT * FROM pg_roles``</p>
<p>y, de no tener permisos de
replicación, alteramos los roles necesarios para ello:</p>
<p>`` postgres# ALTER ROLE nombre WITH REPLICATION``</p>
<p>Una vez hecho todo
esto, ya hemos configurado un sistema de replicación Maestro-Esclavo
utilizando Postgres como sistema manejador de base de datos, y no hizo
falta una toalla para eso. Fácil ¿no?.</p>
<p>[1] <a class="reference external" href="http://developer.postgresql.org/pgdocs/postgres/runtime-config-wal.html">http://developer.postgresql.org/pgdocs/postgres/runtime-config-wal.html</a></p>
<p>[2]`http://developer.postgresql.org/pgdocs/postgres/runtime-config-replication.html#GUC-HOT-STANDBY`_</p>
</div>


<div class="article-footer">
    <p><span class="glyphicon glyphicon-tag" aria-hidden="true"></span> <a href="tag/bases-de-datos.html">Bases de Datos</a> <a href="tag/informatica.html">informática</a> <a href="tag/postgres.html">Postgres</a> <a href="tag/software-libre.html">Software Libre</a> </p>

    <p>Thank you for reading!, don't forget to subscribe to my mailing list!, I don't send any spam and sometimes I do share interesting stuff</p>


<!-- Begin MailChimp Signup Form -->
    <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
    <style type="text/css">
        #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
        /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
           We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
    </style>
    <div id="mc_embed_signup">
    <form action="//iferminmontilla.us11.list-manage.com/subscribe/post?u=0d4b15ef6a90baa460d821dbc&amp;id=8b51ac80b2" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
        <div id="mc_embed_signup_scroll">
        
    <div class="mc-field-group">
        <label for="mce-EMAIL">Email Address </label>
        <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
    </div>
        <div id="mce-responses" class="clear">
            <div class="response" id="mce-error-response" style="display:none"></div>
            <div class="response" id="mce-success-response" style="display:none"></div>
        </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_0d4b15ef6a90baa460d821dbc_8b51ac80b2" tabindex="-1" value=""></div>
        <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
        </div>
    </form>
    </div>
    <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
    <!--End mc_embed_signup-->


</div>

            </div>
        </div>
    </div>
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-8">
                    Created by <a href="http://iferminmontilla.com">Israel Fermín Montilla</a> using <a href="http://getpelican.com" target="_blank">Pelican</a> and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>.
                    All content here is under <a href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US" target="_blank">Attribution-ShareAlike 3.0 Unported</a> license. Logo designed by <a href="https://about.me/andresfermin" target="_blank">Andrés Fermín</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55459920-1', 'auto');
  ga('send', 'pageview');

    </script>
</body>
</html>
