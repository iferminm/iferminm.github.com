<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Configurando réplicas Maestro-Esclavo con Postgres - Israel Fermín Montilla</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="http://iferminmontilla.com/theme/css/pygments.css">
    <link rel="stylesheet" href="http://iferminmontilla.com/theme/css/iferminm.css">
<script type="text/javascript">
    var disqus_identifier = "configurando-replicas-maestro-esclavo-con-postgres.html";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://iferminmblog.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
</head>
<body>
    <div id="header">
        <div id="header-logo-holder">
            <a href="http://iferminmontilla.com"><img src="http://iferminmontilla.com/theme/images/header-logo.png" alt=""></a>    
        </div>
        <div id="logo-text">
            <span><b>Israel Fermín Montilla</b></span>
            <span>Software Engineer</span>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-2">
            <div class="collapse navbar-collapse" id="nav-elements">
                <ul class="nav nav-pills nav-stacked">
                    <li><a href="http://iferminmontilla.com">Blog</a></li>
                <li><a href="/author/israel-fermin-montilla.html">About me</a></li>
                <li><a href="/pages/now.html">Now</a></li>
                </ul>
            </div>
            <div class="under-menu-ad">
                <script src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                <!-- Blog under menu -->
                <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9066997121369275" data-ad-slot="3361083144" data-ad-format="auto"></ins>
                <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
            </div>
        </div>
        <div class="col-xs-9">
            <div id="main-content" class="ckontainer"> 
<div class="article-header">
    <h1>Configurando réplicas Maestro-Esclavo con Postgres</h1> 
    by <a href="author/israel-fermin-montilla.html">Israel Fermín Montilla</a> on Thu 10 Nov, 2011
</div>

<p>Muchas veces, por alguna razón, hacemos desde la capa de
aplicación cientos de validaciones y procesos que, si sabemos cómo,
podríamos delegar en el manejador de base de datos.</p>
<p>Las validaciones de reglas de negocio son un ejemplo muy frecuente de ello, tendemos, por
ejemplo, a implementar validaciones redundantes (en el caso de entornos
web) del lado del cliente, utilizando AJAX, y del lado del servidor,
utilizando el lenguaje de programación que más nos agrade. Esto, añade
un nivel de complejidad a nuestro sistema, cuando, muy tranquilamente,
podríamos delegar esa validación en nuestro manejador de base de datos a
través de un Trigger, con la ventaja de que si algún día, otro sistema
necesita conectarse a la base de datos, las reglas de negocio están
implementadas directamente en el manejador y, como ya estamos
acostumbrados, todo corre más rápido en el nivel más bajo.</p>
<p>Ahora bien, ¿por qué empiezo diciendo todo eso?, simplemente por hacer referencia a
un ejemplo bastante común, en el que nosotros, programadores,
desarrolladores, ingenieros, o como quieran llamarnos, hacemos uso (o
quizás sub-uso) de un software muy sofisticado, como lo es un Manejador
de Base de Datos y, tendemos a pensar, que es sólo un pote para guardar
datos que, además, habla un lenguaje extraño llamado SQL. Otra de las
cosas que, algunas veces, hacemos y nos hacen parecer novatos es
actualizar dos servidores de base de datos distintos disparando
sentencias hacia los dos, o tres, o cuantos sean. Esto añade un nivel de
complejidad innecesario a nuestra aplicación, además de estar
fuertemente acoplado con la arquitectura física (hardware) del sistema
implementado, si el número de servidores a sincronizar cambia, será
necesario también realizar modificaciones a nivel de código o de
configuración del programa y, además, desaprovechamos la potencia que
nos ofrece un manejador de base de datos.</p>
<p>PostgresSQL nos ofrece la posibilidad de sincronizar dos servidores de base de datos mediante
Replicación de manera nativa. Existen distintos tipos de replicación de servidores, en
este caso, configuraremos un esquema Maestro-Esclavo, en el que mi
servidor Maestro, recibe y ejecuta todas las transacciones y, además,
actualiza a mi servidor Esclavo, que, únicamente, utilizo para realizar consultas.
Empezamos por instalar la última versión disponible de Postgres,
utilizando el gestor de paquetes de nuestra distribución de Linux
favorita, para este ejemplo, utilicé Debian Wheezy (Testing) y Postgres
9.1.</p>
<div class="section" id="configurando-el-maestro">
<h2>Configurando el Maestro</h2>
<p>El maestro, es el nodo que ejecuta todas las transacciones de base de
datos, digamos que puede realizar todas las operaciones CRUD. Empecemos
por establecer ciertos valores de configuración para el manejador en el
archivo /etc/postgresql/9.1/main/postgresql.conf. Debemos configurar los
siguientes valores:</p>
<pre class="code bash literal-block">
<span class="nv">listen_addresses</span> <span class="o">=</span> <span class="s1">'*'</span>
<span class="nv">wal_level</span> <span class="o">=</span> hot_standby
<span class="nv">wal_sync_method</span> <span class="o">=</span> fsync
<span class="nv">max_wal_senders</span> <span class="o">=</span> 2
<span class="nv">wal_keep_segments</span> <span class="o">=</span> 8
</pre>
<p>Ahora bien, analicemos este segmento de configuración:</p>
<ul class="simple">
<li><em>listen_addresses:</em> establece las direcciones IP de donde
mi servidor va a aceptar peticiones, este parámetro acepta valores
separados por coma o el caracter asterisco, como en este caso, para
especificar que va a aceptar peticiones de cualquier host, de no ser
así, sólo las IP listadas podrían sincronizar la base de datos.</li>
<li><em>wal_level:</em> donde <strong>wal</strong> quiere decir <strong>Write Ahead Log</strong> y es una
estrategia que implementan los manejadores para cumplir con las
propiedades de Atomicidad y Durabilidad de las transacciones (¿recuerdan
la regla ACID?) y consiste en escribir en un archivo de bitácora todas
las modificaciones realizadas a la base de datos. En Postgres existen
tres: <strong>minimal</strong>, que omite algunas operaciones de escritura para hacer
las operacionas más rápido, pero no guarda información suficiente para
reconstruir la base de datos a partir de un archivo inicial y logs de
este tipo, <strong>hot_standby</strong> y <strong>archive</strong>, almacenan toda la información
necesaria para hacer la reconstrucción completa de los datos, pero
únicamente <strong>hot_standby</strong> permite implementar replicación de base de
datos hacia servidores remotos.</li>
<li><em>wal_sync_method:</em> es el método que utilizará el manejador para forzar las actualizaciones
utilizando <strong>WAL</strong>. En este caso, utilizamos <strong>fsync</strong> que se asegura de que
los cambios sean escritos físicamente en la base de datos copia, más
información sobre los métodos de sincronización disponibles puede
conseguirse en [1].</li>
<li><em>max_wal_senders:</em> establece el número
de sincronizaciones concurrentes que puede ejecutar el servidor.</li>
<li><em>wal_keep_segments</em>, establece el número de <em>WAL</em> logs que
el servidor guardará en el directorio <strong>pg_xlog</strong>, estos logs son
utilizados para realizar las actualizaciones vía streaming. Una vez
hecho lo anterior, tenemos la configuración básica de Postgres para
hacer replicación Maestro-Esclavo vía streaming.</li>
</ul>
<p>Ahora, debemos agregar una regla más de acceso al <strong>pg_hba.conf</strong>, para
permitir a los esclavos conectarse al servidor maestro:</p>
<pre class="code bash literal-block">
host replication all 10.1.1.8/32 trust
</pre>
<p>Con esa línea, estamos configurando el servidor para que permita conexiones a todos los
usuarios con permiso de replicación desde la sub-red <strong>10.1.1.8/32</strong>.</p>
<p>Ahora, generamos los <strong>WAL</strong>, para ello, ejecutamos lo siguiente en el terminal SQL de
Postgres:</p>
<pre class="code sql literal-block">
<span class="k">SELECT</span> <span class="n">pg_start_backup</span><span class="p">(</span><span class="s1">'1'</span><span class="p">)</span>
</pre>
<p>Mientras eso esté ocurriendo, en otro terminal, ejecutamos lo siguiente:</p>
<pre class="code bash literal-block">
<span class="nb">cd</span> /var/lib/postgresql/9.1 <span class="c1"># tar czvf backup.tgz main</span>
</pre>
<p>Con esto estamos comprimiendo el directorio de datos de Postgres.
Una vez hecho esto, detenemos la generación de WAL:</p>
<pre class="code sql literal-block">
<span class="k">SELECT</span> <span class="n">pg_stop_backup</span><span class="p">()</span>
</pre>
<p>El asunto general se resume con la siguiente ecuación:</p>
<p>backup inconsistente + WAL = restauración a estado consistente.</p>
<p>Estos WAL, se generan en el directorio <strong>pg_xlog</strong>, y
debemos tomar el último que fue escrito.</p>
</div>
<div class="section" id="configurando-el-esclavo">
<h2>Configurando el Esclavo</h2>
<p>Lo primero que debemos hacer es sustituir el directorio de datos de esta
instancia de Postgres por el directorio de datos del Maestro. Luego,
creamos un directorio <em>recovery</em>, donde copiaremos el último WAL del
directorio pg_xlog. Adicionalmente, debemos modificar el
postgresql.conf con las siguientes variables:</p>
<pre class="code bash literal-block">
<span class="nv">hot_standby</span> <span class="o">=</span> on <span class="nv">wal_level</span> <span class="o">=</span> hot_standby<span class="sb">``</span>
</pre>
<p>Ahora, creamos un archivo
de configuración en la raíz del directorio de datos para establecer las
siguientes opciones:</p>
<pre class="code bash literal-block">
<span class="nv">standby_mode</span> <span class="o">=</span> <span class="s1">'on'</span>
<span class="nv">primary_conninfo</span> <span class="o">=</span> <span class="s1">'host=[host_ip] port=5432 user=root password=[some_password]'</span>
<span class="nv">restore_command</span> <span class="o">=</span> <span class="s1">'cp /var/lib/postgresql/9.1/main/recovery/%f %p'</span>
</pre>
<p>Con esto le decimos al servidor que va a esperar réplicas de
<strong>primary_conninfo</strong>, además, el <strong>restore_command</strong> indica dónde se
encuentra el respaldo inicial inconsistente. Finalmente, nos aseguramos
de que los roles tengan permiso de replicación:</p>
<pre class="code sql literal-block">
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">pg_roles</span>
</pre>
<p>y, de no tener permisos de
replicación, alteramos los roles necesarios para ello:</p>
<pre class="code sql literal-block">
<span class="k">ALTER</span> <span class="k">ROLE</span> <span class="n">nombre</span> <span class="k">WITH</span> <span class="n">REPLICATION</span>
</pre>
<p>Una vez hecho todo
esto, ya hemos configurado un sistema de replicación Maestro-Esclavo
utilizando Postgres como sistema manejador de base de datos, y no hizo
falta una toalla para eso. Fácil ¿no?.</p>
<p>[1] <a class="reference external" href="http://developer.postgresql.org/pgdocs/postgres/runtime-config-wal.html">http://developer.postgresql.org/pgdocs/postgres/runtime-config-wal.html</a></p>
<p>[2] <a class="reference external" href="http://developer.postgresql.org/pgdocs/postgres/runtime-config-replication.html#GUC-HOT-STANDBY">http://developer.postgresql.org/pgdocs/postgres/runtime-config-replication.html#GUC-HOT-STANDBY</a></p>
</div>


<div class="article-footer">
    <p><span class="glyphicon glyphicon-tag" aria-hidden="true"></span> <a href="tag/bases-de-datos.html">Bases de Datos</a> <a href="tag/informatica.html">informática</a> <a href="tag/postgres.html">Postgres</a> <a href="tag/software-libre.html">Software Libre</a> </p>

        <a href="https://twitter.com/share" class="twitter-share-button" data-via="iferminm" data-size="large" data-dnt="true">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

        <div class="fb-share-button" data-href="http://iferminmontilla.com/configurando-replicas-maestro-esclavo-con-postgres.html" data-layout="button"></div>

        <div id="fb-root"></div>
        <script>
            (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.5&appId=457325330963820";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>

    <p>Thank you for reading!, don't forget to subscribe to my mailing list!, I don't send any spam and sometimes I do share interesting stuff</p>


<!-- Begin MailChimp Signup Form -->
    <link href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css" rel="stylesheet" type="text/css">
    <style type="text/css">
        #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
        /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
           We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
    </style>
    <div id="mc_embed_signup">
    <form action="//iferminmontilla.us11.list-manage.com/subscribe/post?u=0d4b15ef6a90baa460d821dbc&amp;id=8b51ac80b2" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
        <div id="mc_embed_signup_scroll">
        
    <div class="mc-field-group">
        <label for="mce-EMAIL">Email Address </label>
        <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
    </div>
        <div id="mce-responses" class="clear">
            <div class="response" id="mce-error-response" style="display:none"></div>
            <div class="response" id="mce-success-response" style="display:none"></div>
        </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_0d4b15ef6a90baa460d821dbc_8b51ac80b2" tabindex="-1" value=""></div>
        <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
        </div>
    </form>
    </div>
    <script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';}(jQuery));var $mcj = jQuery.noConflict(true);</script>
    <!--End mc_embed_signup-->

</div>

<div id="disqus_thread"></div>
            </div>
        </div>
    </div>
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="col-xs-8">
                    Created by <a href="http://iferminmontilla.com">Israel Fermín Montilla</a> using <a href="http://getpelican.com" target="_blank">Pelican</a> and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>.
                    All content here is under <a href="https://creativecommons.org/licenses/by-sa/3.0/deed.en_US" target="_blank">Attribution-ShareAlike 3.0 Unported</a> license. Logo designed by <a href="https://about.me/andresfermin" target="_blank">Andrés Fermín</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Latest compiled and minified JavaScript -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

    <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
           (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       ga('create', 'UA-55459920-1', 'auto');
       ga('send', 'pageview');
    </script>

</body>
</html>
