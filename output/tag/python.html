<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>A Pelican Blog - python</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="A Pelican Blog Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">A Pelican Blog</a></h1>
                <nav><ul>
                    <li><a href="/pages/about-me.html">About me...</a></li>
                    <li><a href="/pages/consulting.html">Consulting</a></li>
                    <li><a href="/pages/now.html">Now</a></li>
                    <li><a href="/pages/talks.html">Talks</a></li>
                    <li><a href="/category/blog.html">Blog</a></li>
                    <li><a href="/category/espanol.html">Español</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/working-with-databases-easier.html">Working with databases easier</a></h1>
<footer class="post-info">
        <abbr class="published" title="2020-04-01T00:00:00+00:00">
                Published: Wed 01 April 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> <a href="/tag/databases.html">databases</a> <a href="/tag/sqlalchemy.html">sqlalchemy</a> <a href="/tag/orm.html">orm</a> </p>
</footer><!-- /.post-info --><p>This will be a short article, recently at work I had to build few reports on
top of two legacy databases, to be honest, the whole architecture and the way
the data is stored, in my opinion, is not optimal, a lot of things need to change
but, as usual, features and business take precedence over tech debt.</p>
<p>The whole stack is based on nodejs on top of typescript, which makes a bit more
enjoyable the fact that I'm now working in JavaScript. All the databases were
generated using knexjs so, these databases were there already and I only had to
connect to them.</p>
<p>I didn't want to spend too much time on the connection and mapping part, so
I wanted to see if an ORM would be of use here</p>
<h2>The overall idea</h2>
<p>Since we will be integrating with other internal tools to generate these reports
the implementation I came up with is temporary, so I wanted to make as few changes
as possible in the current codebase for several reasons:</p>
<ol>
<li>
<p>Once you add something temporary, it will be difficult to clean it up
after it's not needed anymore, the chances of someone building on top of it 
is high.</p>
</li>
<li>
<p>I don't like working with typescript, or JavaScript in general so if I could
get away with writing in some other language it could be more fun</p>
</li>
<li>
<p>The current application is a monolith and the logic is complex,
adding more would take longer than implementing something from scratch</p>
</li>
</ol>
<p>So, I decided to implement the report generating logic in a Lambda function
which will be executed periodically, this meant I had to setup the connections
to the databases from scratch and map to my domain classes and types in order
to have a clean architecture.</p>
<h2>Enter Sqlalchemy</h2>
<p>Sqlalchemy is the database Swiss army knife in python, it makes it very
easy to work with databases by mapping tables to domain classes, but it also
works the other way around by introspecting the database's schema metadata and
generating stub classes to deal with them in Python.</p>
<h3>Automap</h3>
<p>Sqlalchemy has an Automap extension, which lets you connect to an existing database
and generate a domain model from the existing database schema and operate with it
from Python, trigger queries and use Sqlalchemy normally as if the schema was generated
by you.</p>
<p>It's very easy and it doesn't take 30 lines of code</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.ext.automap</span> <span class="kn">import</span> <span class="n">automap_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>


<span class="n">DATABASE_URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DB_URL&#39;</span><span class="p">)</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">automap_base</span><span class="p">()</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">DATABASE_URL</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="n">Base</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">reflect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>


<p>Then you can access the classes with the table name as it is in the database let's say you have a
<code>user_profile</code> database, then you can access it as</p>
<div class="highlight"><pre><span></span><code><span class="n">Base</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">user_profile</span>
</code></pre></div>


<p>Trigger queries as</p>
<div class="highlight"><pre><span></span><code><span class="n">UserProfile</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">classes</span><span class="o">.</span><span class="n">user_profile</span>

<span class="n">profile</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">UserProfile</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">UserProfile</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="mi">123123</span><span class="p">)</span><span class="o">.</span><span class="n">fist</span><span class="p">()</span>
</code></pre></div>


<p>And you're good to go.</p>
<p>Of course, code conventions in SQL and Python are different, if you want your code to look more pythonic
and have <code>Base.classes.*</code> to be in PascalCase as well, you can write a function to override the table naming
when the automap is performed, it will add few lines but still below 20 lines in general</p>
<p>It looks something like this</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">snake_to_pascal</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">tablename</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">tablename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)])</span>
</code></pre></div>


<p>Of course, that assumes your tables are named as <code>this_is_a_table</code> and will be converted to <code>ThisIsATable</code></p>
<p>You can use that function when you call <code>Base.prepare</code> as follows</p>
<div class="highlight"><pre><span></span><code><span class="n">Base</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">reflect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">classname_for_table</span><span class="o">=</span><span class="n">snake_to_pascal</span><span class="p">)</span>
</code></pre></div>


<p>And that's it. :-)</p>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="/django-registration-in-no-time.html" rel="bookmark"
                           title="Permalink to Django registration in no time!">Django registration in no time!</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-01-23T00:00:00+00:00">
                Published: Tue 23 January 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> <a href="/tag/django.html">django</a> <a href="/tag/tutorial.html">tutorial</a> <a href="/tag/registration.html">registration</a> </p>
</footer><!-- /.post-info -->                <p>What does 99% of the projects we work on have in common?, what's usually the first or the last
thing we start working on when building something, a personal project perhaps?. If you said
<em>dealing with users</em>, that's right. On each and every project we find ourselves writing different
registration …</p>
                <a class="readmore" href="/django-registration-in-no-time.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/making-django-scale-pt2.html" rel="bookmark"
                           title="Permalink to Making django scale Pt.2">Making django scale Pt.2</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-12-24T00:00:00+00:00">
                Published: Sun 24 December 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>.</p>
<p>tags: <a href="/tag/python.html">Python</a> <a href="/tag/django.html">django</a> <a href="/tag/scaling.html">scaling</a> </p>
</footer><!-- /.post-info -->                <p>It's been a while since the <a href="/making-django-scale-pt1.html">first post</a> about scaling web applications using <em>django</em>, last time we
spoke about some basic concepts about scalability, buzz words we hear everyday and we also use but
always struggle when we need to give a formal definition to someone.</p>
<p>Once we have clear …</p>
                <a class="readmore" href="/making-django-scale-pt2.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/making-django-scale-pt1.html" rel="bookmark"
                           title="Permalink to Making django scale Pt.1">Making django scale Pt.1</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-09-24T00:00:00+00:00">
                Published: Sun 24 September 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> <a href="/tag/django.html">django</a> <a href="/tag/scaling.html">scaling</a> </p>
</footer><!-- /.post-info -->                <p>I gave a talk on PyConPL this year about scaling django, obviously on a 35min talk you don't have enough
time to outline all the strategies and go deeper, so I thought it might be a cool idea to write a series
of blog posts  about this topic, not only …</p>
                <a class="readmore" href="/making-django-scale-pt1.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/classy-tasks-with-celery.html" rel="bookmark"
                           title="Permalink to Classy Tasks with Celery">Classy Tasks with Celery</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-03-23T00:00:00+00:00">
                Published: Thu 23 March 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> <a href="/tag/programming.html">programming</a> <a href="/tag/celery.html">celery</a> </p>
</footer><!-- /.post-info -->                <p>This will be a short article, I just want to share something I learned this week.</p>
<p>If you work with <em>Python</em> and chances are you've ran into <em>celery</em> at least once, hopefully more than once, depending on how complex the projects
you've worked on are.</p>
<p>If you don't know it …</p>
                <a class="readmore" href="/classy-tasks-with-celery.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/the-evilness-of-none.html" rel="bookmark"
                           title="Permalink to The evilness of None!">The evilness of None!</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-03-13T00:00:00+00:00">
                Published: Mon 13 March 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
        </address>
<p>In <a href="/category/blog.html">Blog</a>.</p>
<p>tags: <a href="/tag/programming.html">programming</a> <a href="/tag/python.html">python</a> </p>
</footer><!-- /.post-info -->                <p>Recently at work, i was solving one bug on one of our services, it was popping up in newrelic at least 9 times a week, this is one of the services we use in the monetization process at the office, so, it's a critical one, the least errors we 
see …</p>
                <a class="readmore" href="/the-evilness-of-none.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/django-vistas-basadas-en-clases.html" rel="bookmark"
                           title="Permalink to Django: vistas basadas en clases">Django: vistas basadas en clases</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-07-25T00:00:00+00:00">
                Published: Sat 25 July 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
        </address>
<p>In <a href="/category/espanol.html">Español</a>.</p>
<p>tags: <a href="/tag/django.html">django</a> <a href="/tag/python.html">python</a> <a href="/tag/vistas-basadas-en-clases.html">vistas basadas en clases</a> <a href="/tag/cbv.html">cbv</a> </p>
</footer><!-- /.post-info -->                <p>Tenía pendiente escribir sobre esto desde hace tiempo, pero entre una
cosa y otra siempre terminaba escribiendo sobre otra cosa y las vistas
basadas en clases quedaban olvidadas.</p>
<p>Las vistas basadas en clases nos permiten simplificar muchísimo el
código, reduciendo, para muchos casos, la escritura de vistas a
simplemente heredar …</p>
                <a class="readmore" href="/django-vistas-basadas-en-clases.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/cosas-que-he-aprendido-descriptores.html" rel="bookmark"
                           title="Permalink to Cosas que he aprendido: Descriptores">Cosas que he aprendido: Descriptores</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-12-01T00:00:00+00:00">
                Published: Mon 01 December 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
        </address>
<p>In <a href="/category/espanol.html">Español</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> <a href="/tag/programacion.html">programación</a> <a href="/tag/descriptores.html">descriptores</a> </p>
</footer><!-- /.post-info -->                <p>Bueno, llevo ya unos años dedicado casi 100% a desarrollo web con
<em>Python</em>, unos años en los que he aprendido muchas cosas sobre el
lenguaje y, por un momento, pensé que sabía suficiente, pero cuando uno
empieza a pensar eso es peligroso, al final, nunca se sabe suficiente y
siempre …</p>
                <a class="readmore" href="/cosas-que-he-aprendido-descriptores.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/heroku-django-sin-morir-en-el-intento-parte-2.html" rel="bookmark"
                           title="Permalink to Heroku + Django sin morir en el intento (Parte 2)">Heroku + Django sin morir en el intento (Parte 2)</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-09-20T00:00:00+00:00">
                Published: Sat 20 September 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
        </address>
<p>In <a href="/category/espanol.html">Español</a>.</p>
<p>tags: <a href="/tag/heroku.html">heroku</a> <a href="/tag/paas.html">PAAS</a> <a href="/tag/python.html">python</a> <a href="/tag/django.html">django</a> </p>
</footer><!-- /.post-info -->                <p>En el artículo anterior, hablamos de IaaS y de PaaS y de cómo se
diferencian concluimos que <em>Heroku</em> es PaaS, además, expusimos algunas
de las limitaciones que nos impone la plataforma para desplegar nuestras
aplicaciones y cómo trabajar alrededor de ellas para hacer funcionar
todo.</p>
<p>Muchas veces, quizás por inocentes …</p>
                <a class="readmore" href="/heroku-django-sin-morir-en-el-intento-parte-2.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/heroku-django-sin-morir-en-el-intento-parte-1.html" rel="bookmark"
                           title="Permalink to Heroku + Django sin morir en el intento (Parte 1)">Heroku + Django sin morir en el intento (Parte 1)</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-09-23T00:00:00+00:00">
                Published: Mon 23 September 2013
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
        </address>
<p>In <a href="/category/espanol.html">Español</a>.</p>
<p>tags: <a href="/tag/heroku.html">heroku</a> <a href="/tag/django.html">django</a> <a href="/tag/python.html">python</a> <a href="/tag/paas.html">PAAS</a> </p>
</footer><!-- /.post-info -->                <p>Antes, para tener tu sistema web en línea, debías contratar un servicio
de Servidor Dedicado o mínimo un VPS y administrarlo, si tenías más
presupuesto, comprabas un servidor y lo acondicionabas o alquilabas un
rack en algún centro de datos para tenerlo colocado allí.</p>
<p>Ahora, con el boom de <em>Infraestructura …</em></p>
                <a class="readmore" href="/heroku-django-sin-morir-en-el-intento-parte-1.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/clientes-soap-en-python.html" rel="bookmark"
                           title="Permalink to Clientes SOAP en Python">Clientes SOAP en Python</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-08-18T00:00:00+00:00">
                Published: Sun 18 August 2013
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
        </address>
<p>In <a href="/category/espanol.html">Español</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> <a href="/tag/soap.html">soap</a> <a href="/tag/soa.html">soa</a> <a href="/tag/suds.html">suds</a> </p>
</footer><!-- /.post-info -->                <p>Como todos saben, y algunos me chalequean por eso, en la primera mitad
de 2013 cambié de trabajo dos veces, estaba algo aburrido en Metamax y
decidí aceptar una oportunidad en 4geeks, junto con una serie de
proyectos para una empresa en el extranjero que pintaban bastante bien,
una vez …</p>
                <a class="readmore" href="/clientes-soap-en-python.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/mi-experiencia-en-el-pyconve-2012-y-otros-cuentos.html" rel="bookmark"
                           title="Permalink to Mi experiencia en el PyConVE 2012 y otros cuentos">Mi experiencia en el PyConVE 2012 y otros cuentos</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2012-11-18T00:00:00+00:00">
                Published: Sun 18 November 2012
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/israel-fermin-montilla.html">Israel Fermín Montilla</a>
        </address>
<p>In <a href="/category/espanol.html">Español</a>.</p>
<p>tags: <a href="/tag/pycon.html">pycon</a> <a href="/tag/pyve.html">pyve</a> <a href="/tag/python.html">python</a> </p>
</footer><!-- /.post-info -->                <p>Bueno, ya ha pasado una semana y alguito desde que terminó la primera
Conferencia del Lenguaje Python de Venezuela (PyConVE), he tenido algo
de tiempo para reflexionar y pensar acerca de varias cosas que me
ocurrieron antes del evento, es decir, mientras se estaba organizando,
durante el evento y después …</p>
                <a class="readmore" href="/mi-experiencia-en-el-pyconve-2012-y-otros-cuentos.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>